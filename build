#!/bin/sh
#
# The main menu for building MaxWit Lablin
#
# http://www.maxwit.com
# http://maxwit.googlecode.com
#
# Authors:
#     Tiger Yu   <tiger@maxwit.com>
#     Conke Hu   <conke@maxwit.com>
#     Fleya Hou  <fleya@maxwit.com>
#


MW_TOP_DIR=`dirname $0`
cd ${MW_TOP_DIR}
MW_TOP_DIR=${PWD}


. core/bmw_menu
. core/bmw_pkgs
. core/bmw_base

. host/build
. toolchain/build
. target/build


BUILD_JOBS="-j1"


echo ${PATH} | grep "${UTILS_ROOT}" > /dev/null || export PATH=${UTILS_ROOT}/usr/bin:${PATH}
export LD_LIBRARY_PATH=${UTILS_ROOT}/usr/lib
export PKG_CONFIG_PATH=${ROOTFS_PATH}/usr/lib/pkgconfig/


if [ "${1}" == "all" ]; then
	for dir in `ls ${MAXWIT_TOP}`
	do
		echo "Removing ${MAXWIT_TOP}/${dir}"
		rm -rf ${MAXWIT_TOP}/${dir}
	done
 
	build_utils && \
	build_toolchain && \
	build_basic_rootfs && \
	build_linux_kernel && \
	build_all_app && \
	run_qemu

	exit 0
fi


while true
do
	show_menu "[MaxWit Lablin Building Menu] (for ${TARGET_SOC})" \
			"Host Check & Setup (sudo)" \
			"Build GNU Toolchain and Emulator" \
			"Build Basic System (${MWP_KERNEL} & busybox)" \
			"Build Applications (Lib/App/Games)" \
			"Testing on QEMU" \
			"Create File System Images (UBI/YAFFS2/JFFS2,etc.)"

	case $? in
	1)
		grep "${MAXWIT_TOP}" /etc/exports > /dev/null 2>&1 || \
		{
			sudo chmod 666 /etc/exports
			echo >> /etc/exports
			echo "${MAXWIT_TOP} *(rw,sync,no_subtree_check,no_root_squash)" >> /etc/exports
			sudo exportfs
		}

		qemu_setup
		;;

	2)
		# build_emulator && \
		build_utils && \
		build_toolchain || exit 1
	    ;;

	3)
		build_basic_rootfs || exit 1
		build_linux_kernel || exit 1
		# build_root_std || exit 1
		;;

	4)
		build_all_app || exit 1
		;;

	5)
		run_qemu
		;;

	6)
		create_image
		;;

	*)
		echo "Wrong Choice! Please Try Again."
		;;
	esac

	echo
done
